# script to move archived directories from the Archive dir on the main share to a holding area.

. /usr/local/etc/backup.conf

if [ -z "`find $ARCHIVE_DIR -mindepth 1 -maxdepth 1 -type d`" ]; then
  exit 0
fi

datePrefix=`date '+%F'`

echo "Moving directories to store."
find $ARCHIVE_DIR -mindepth 1 -maxdepth 1 -type d | (
  while read d; do
    dname=${d##*/}
    dest=$STORE_DIR/$datePrefix-$dname
    echo -n "$d -> $dest ... "
    if [ -d $dest ] ; then
      echo DUPLICATE
    else
      if mv -n $d $dest ; then
        # set permissions to be read only (+ execute for dirs)
        find $dest -type d -print0 | xargs -0 chmod a=rx
        find $dest -type f -print0 | xargs -0 chmod a=r
        echo OK
      else
        echo ERROR
      fi
    fi
  done
)

echo "Finished moving directories to archive store."
